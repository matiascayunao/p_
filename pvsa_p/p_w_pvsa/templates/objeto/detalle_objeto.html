{# templates/objeto/detalle_objeto.html #}
{% extends "base.html" %}
{% block content %}
<div class="container-xxl py-4" style="max-width: 1150px;">

  <div class="d-flex flex-wrap align-items-start justify-content-between gap-2 mb-3">
    <div>
      <div class="text-muted small">Detalle de objeto</div>
      <h2 class="mb-1">{{ objeto.nombre_del_objeto }}</h2>
      <div class="text-muted">
        Categoría:
        <span class="fw-semibold">
          {% if objeto.objeto_categoria %}
            {{ objeto.objeto_categoria.nombre_de_categoria|default:objeto.objeto_categoria }}
          {% else %}
            {{ objeto.categoria|default:"—" }}
          {% endif %}
        </span>
        <span class="text-muted">·</span>
        <span class="badge rounded-pill text-bg-light border">
          Tipos: <strong class="ms-1">{{ tipos|length }}</strong>
        </span>
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'lista_objetos' %}">&laquo; Volver</a>
      <a class="btn btn-primary" href="{% url 'crear_tipo_objeto' %}">+ Crear tipo de objeto</a>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="card-header bg-white border-0 p-3 p-md-4 d-flex justify-content-between align-items-center">
      <div>
        <div class="fw-bold">Tipos (marca / material)</div>
        <div class="text-muted small">Selecciona uno para ver su detalle y dónde se usa</div>
      </div>
      <span class="badge rounded-pill text-bg-light border">
        Total: <strong class="ms-1">{{ tipos|length }}</strong>
      </span>
    </div>

    <div class="card-body p-0">
      {% if tipos %}
        <div class="list-group list-group-flush">
          {% for t in tipos %}
            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
               href="{% url 'detalle_tipo_objeto' tipo_objeto_id=t.id %}">
              <div>
                <div class="fw-semibold">
                  {% if t.marca %}{{ t.marca }}{% else %}Sin marca{% endif %}
                  {% if t.material %}<span class="text-muted">/</span> {{ t.material }}{% else %}<span class="text-muted">/ Sin material</span>{% endif %}
                </div>
                <div class="text-muted small">ID: {{ t.id }}</div>
              </div>
              <span class="text-muted">Ver &raquo;</span>
            </a>
          {% endfor %}
        </div>
      {% else %}
        <div class="p-4">
          <div class="alert alert-secondary mb-0 rounded-4">
            No hay tipos registrados para este objeto.
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="mt-3 d-flex flex-wrap gap-2">
    <a class="btn btn-outline-primary" href="{% url 'editar_objeto' objeto_id=objeto.id %}">Editar</a>

    <button
      type="button"
      class="btn btn-outline-danger"
      data-bs-toggle="modal"
      data-bs-target="#confirmDeleteModal"
      data-delete-url="{% url 'borrar_objeto' objeto_id=objeto.id %}"
      data-delete-name="{{ objeto.nombre_del_objeto|escape }}"
    >
      Borrar
    </button>
  </div>

  {# ===== MODAL CONFIRMAR BORRADO ===== #}
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar borrado</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">¿Seguro que quieres borrar:</div>
          <div class="fw-semibold" id="deleteTargetName">—</div>
          <div class="text-muted small mt-2">
            Si este objeto tiene tipos u otros elementos ligados, no se podrá borrar.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <form method="post" id="deleteForm" action="#">
            {% csrf_token %}
            <button class="btn btn-danger" type="submit">Sí, borrar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  {# ===== MODAL BLOQUEADO (RELACIONES) ===== #}
  <div class="modal fade" id="blockedDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">No se puede borrar</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          Este elemento aún tiene cosas ligadas. Primero elimina o desvincula lo relacionado y vuelve a intentar.
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const confirmModal = document.getElementById("confirmDeleteModal");
  const deleteForm = document.getElementById("deleteForm");
  const nameEl = document.getElementById("deleteTargetName");

  if (confirmModal) {
    confirmModal.addEventListener("show.bs.modal", function (event) {
      const btn = event.relatedTarget;
      const url = btn?.getAttribute("data-delete-url") || "#";
      const name = btn?.getAttribute("data-delete-name") || "—";
      if (deleteForm) deleteForm.action = url;
      if (nameEl) nameEl.textContent = name;
    });
  }

  const params = new URLSearchParams(window.location.search);
  if (params.get("blocked") === "1") {
    const blocked = document.getElementById("blockedDeleteModal");
    if (blocked && typeof bootstrap !== "undefined") {
      new bootstrap.Modal(blocked).show();
    }
  }
});
</script>
{% endblock %}
