{% extends "base.html" %}
{% block content %}
<div class="container-xxl py-4" style="max-width:1280px;">

  <div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-3">
    <div>
      <nav aria-label="breadcrumb" class="small">
        <ol class="breadcrumb mb-2">
          <li class="breadcrumb-item"><a href="{% url 'home' %}">Inicio</a></li>
          <li class="breadcrumb-item"><a href="{% url 'lista_tipos_lugar' %}">Tipos de lugar</a></li>
          <li class="breadcrumb-item active" aria-current="page">{{ tipo.tipo_de_lugar }}</li>
        </ol>
      </nav>

      <h1 class="h4 fw-bold mb-1">Tipo de lugar: {{ tipo.tipo_de_lugar }}</h1>
      <div class="text-muted">
        Aquí configuras los <strong>objetos típicos</strong> y revisas los <strong>lugares</strong> que usan este tipo.
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'lista_tipos_lugar' %}">Volver</a>
      <a class="btn btn-outline-primary" href="{% url 'editar_tipo_lugar' tipo_lugar_id=tipo.id %}">Editar</a>
      <a class="btn btn-outline-danger" href="{% url 'borrar_tipo_lugar' tipo_lugar_id=tipo.id %}">Borrar</a>
    </div>
  </div>

  <div class="row g-3">

    <!-- Configurar típicos -->
    <div class="col-12 col-lg-8">
      <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-header bg-white border-0 p-3 p-md-4">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
            <div>
              <div class="fw-bold">Objetos típicos</div>
              <div class="text-muted small">
                Marca los tipos de objeto que deberían sugerirse por defecto cuando creas un lugar de este tipo.
              </div>
            </div>
            <div class="text-muted small">
              Seleccionados: <span id="contadorTipicos" class="fw-semibold">0</span>
            </div>
          </div>
        </div>

        <div class="card-body p-3 p-md-4">
          <form method="post">
            {% csrf_token %}

            <div class="row g-2 align-items-end mb-3">
              <div class="col-12 col-md-8">
                <label class="form-label small text-muted mb-1">Buscar</label>
                <input id="buscarTipoObjeto" type="search" class="form-control"
                       placeholder="Buscar por categoría, objeto, marca o material...">
              </div>
              <div class="col-12 col-md-4 d-grid">
                <button class="btn btn-primary" type="submit">Guardar cambios</button>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width:42px;"></th>
                    <th style="min-width:160px;">Categoría</th>
                    <th style="min-width:180px;">Objeto</th>
                    <th style="min-width:220px;" class="text-nowrap">Marca / Material</th>
                  </tr>
                </thead>
                <tbody id="tablaTiposObjeto">
                  {% for t in tipos_objeto %}
                    <tr>
                      <td>
                        <input
                          class="form-check-input js-tipico"
                          type="checkbox"
                          name="tipicos"
                          value="{{ t.id }}"
                          {% if t.id in tipicos_ids %}checked{% endif %}
                        >
                      </td>
                      <td class="text-muted">{{ t.objeto.objeto_categoria.nombre_de_categoria }}</td>
                      <td class="fw-semibold">{{ t.objeto.nombre_del_objeto }}</td>
                      <td class="text-muted">
                        {% if t.marca %}{{ t.marca }}{% endif %}
                        {% if t.material %} {{ t.material }}{% endif %}
                        {% if not t.marca and not t.material %}-{% endif %}
                      </td>
                    </tr>
                  {% empty %}
                    <tr>
                      <td colspan="4" class="text-muted">No hay tipos de objeto registrados.</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="d-grid d-md-none mt-3">
              <button class="btn btn-primary" type="submit">Guardar cambios</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Listado típico + lugares -->
    <div class="col-12 col-lg-4">

      <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-header bg-white border-0 p-3 p-md-4">
          <div class="fw-bold">Listado de objetos típicos</div>
          <div class="text-muted small">Orden actual (según selección).</div>
        </div>
        <div class="card-body p-3 p-md-4">
          {% if tipicos %}
            <div class="list-group">
              {% for rel in tipicos %}
                <div class="list-group-item d-flex align-items-start justify-content-between gap-2">
                  <div>
                    <div class="small text-muted">{{ rel.tipo_objeto.objeto.objeto_categoria.nombre_de_categoria }}</div>
                    <div class="fw-semibold">{{ rel.tipo_objeto.objeto.nombre_del_objeto }}</div>
                    {% if rel.tipo_objeto.marca or rel.tipo_objeto.material %}
                      <div class="text-muted small">
                        {% if rel.tipo_objeto.marca %}{{ rel.tipo_objeto.marca }}{% endif %}
                        {% if rel.tipo_objeto.material %} {{ rel.tipo_objeto.material }}{% endif %}
                      </div>
                    {% endif %}
                  </div>
                  <span class="badge text-bg-light border">#{{ forloop.counter }}</span>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted">Aún no hay objetos típicos configurados.</div>
          {% endif %}
        </div>
      </div>

      <div class="card border-0 shadow-sm rounded-4 overflow-hidden mt-3">
        <div class="card-header bg-white border-0 p-3 p-md-4">
          <div class="fw-bold">Lugares con este tipo</div>
          <div class="text-muted small">Lugares que actualmente usan este tipo de lugar.</div>
        </div>
        <div class="card-body p-3 p-md-4">
          {% if lugares %}
            <ul class="list-group list-group-flush">
              {% for l in lugares %}
                <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                  <span>{{ l.nombre_del_lugar }}</span>
                  <a class="btn btn-outline-secondary btn-sm" href="{% url 'detalle_lugar' l.id %}">Ver</a>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-muted">No hay lugares asociados a este tipo de lugar.</div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>

</div>

<script>
  function actualizarContador() {
    const checks = document.querySelectorAll(".js-tipico");
    let c = 0;
    checks.forEach(ch => { if (ch.checked) c++; });
    const el = document.getElementById("contadorTipicos");
    if (el) el.textContent = c;
  }

  function filtrarTabla() {
    const inp = document.getElementById("buscarTipoObjeto");
    const q = (inp ? inp.value : "").toLowerCase().trim();
    const rows = document.querySelectorAll("#tablaTiposObjeto tr");
    rows.forEach(tr => {
      const txt = tr.innerText.toLowerCase();
      tr.style.display = txt.includes(q) ? "" : "none";
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    actualizarContador();
    document.querySelectorAll(".js-tipico").forEach(ch => ch.addEventListener("change", actualizarContador));
    const inp = document.getElementById("buscarTipoObjeto");
    if (inp) inp.addEventListener("input", filtrarTabla);
  });
</script>
{% endblock %}