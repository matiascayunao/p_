{# templates/objeto_lugar/detalle_objeto_lugar.html #}
{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-xxl py-4" style="max-width: 1150px;">

  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div class="d-flex flex-wrap gap-2">
      {% if objeto_lugar.lugar %}
        <a href="{% url 'detalle_lugar' lugar_id=objeto_lugar.lugar.id %}" class="btn btn-outline-secondary btn-sm">
          Volver al lugar
        </a>
        <a href="{% url 'lista_objetos_lugar' %}?lugar={{ objeto_lugar.lugar.id }}" class="btn btn-outline-secondary btn-sm">
          Ver lista de objetos del lugar
        </a>
      {% else %}
        <a href="{% url 'lista_objetos_lugar' %}" class="btn btn-outline-secondary btn-sm">
          Volver a lista
        </a>
      {% endif %}
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-primary btn-sm" href="{% url 'editar_objeto_lugar' objeto_lugar_id=objeto_lugar.id %}">
        Editar
      </a>

      <button
        type="button"
        class="btn btn-outline-danger btn-sm"
        data-bs-toggle="modal"
        data-bs-target="#confirmDeleteModal"
        data-delete-url="{% url 'borrar_objeto_lugar' objeto_lugar_id=objeto_lugar.id %}"
        data-delete-name="{% if objeto_lugar.tipo_de_objeto and objeto_lugar.tipo_de_objeto.objeto %}{{ objeto_lugar.tipo_de_objeto.objeto.nombre_del_objeto|escape }}{% else %}Registro{% endif %}"
      >
        Borrar
      </button>
    </div>
  </div>

  <div class="mb-3">
    <div class="text-muted small">Ruta</div>
    <div class="fw-semibold">
      {% if objeto_lugar.lugar %}
        Sector: {{ objeto_lugar.lugar.piso.ubicacion.sector.sector }}
        <span class="text-muted">/</span>
        Ubicación: {{ objeto_lugar.lugar.piso.ubicacion.ubicacion }}
        <span class="text-muted">/</span>
        Piso: {{ objeto_lugar.lugar.piso.piso }}
        <span class="text-muted">/</span>
        Lugar: {{ objeto_lugar.lugar.nombre_del_lugar }}
      {% else %}
        Sin lugar asignado
      {% endif %}
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-3">
    <div class="card-body p-4">
      <div class="row g-4 align-items-start">

        <div class="col-12 col-lg-6">
          <div class="text-muted small mb-1">Objeto registrado</div>

          <h1 class="h4 fw-bold mb-1">
            {% if objeto_lugar.tipo_de_objeto and objeto_lugar.tipo_de_objeto.objeto %}
              {{ objeto_lugar.tipo_de_objeto.objeto.nombre_del_objeto }}
            {% else %}
              Objeto no especificado
            {% endif %}
          </h1>

          <div class="text-muted">
            {% if objeto_lugar.tipo_de_objeto and objeto_lugar.tipo_de_objeto.objeto and objeto_lugar.tipo_de_objeto.objeto.objeto_categoria %}
              Categoría: <span class="fw-semibold">{{ objeto_lugar.tipo_de_objeto.objeto.objeto_categoria.nombre_de_categoria }}</span>
            {% else %}
              Categoría: <span class="fw-semibold">—</span>
            {% endif %}
          </div>

          <div class="mt-2">
            <div class="row g-2">
              <div class="col-12 col-md-6">
                <div class="small text-muted">Marca</div>
                <div class="fw-semibold">
                  {% if objeto_lugar.tipo_de_objeto and objeto_lugar.tipo_de_objeto.marca %}
                    {{ objeto_lugar.tipo_de_objeto.marca }}
                  {% else %}
                    Sin marca
                  {% endif %}
                </div>
              </div>
              <div class="col-12 col-md-6">
                <div class="small text-muted">Material</div>
                <div class="fw-semibold">
                  {% if objeto_lugar.tipo_de_objeto and objeto_lugar.tipo_de_objeto.material %}
                    {{ objeto_lugar.tipo_de_objeto.material }}
                  {% else %}
                    Sin material
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <div class="small text-muted">Detalle / Observación</div>
            <div class="fw-semibold">
              {% if objeto_lugar.detalle %}
                {{ objeto_lugar.detalle }}
              {% else %}
                —
              {% endif %}
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="text-muted small mb-2">Estado actual</div>

          <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
            <span class="badge rounded-pill text-bg-light border px-3 py-2">
              Cantidad: <strong class="ms-1">{{ objeto_lugar.cantidad }}</strong>
            </span>

            {% with est=objeto_lugar.get_estado_display %}
              {% if est == "Bueno" %}
                <span class="badge rounded-pill bg-success px-3 py-2">Estado: Bueno</span>
              {% elif est == "Pendiente" %}
                <span class="badge rounded-pill bg-warning text-dark px-3 py-2">Estado: Pendiente</span>
              {% else %}
                <span class="badge rounded-pill bg-danger px-3 py-2">Estado: Malo</span>
              {% endif %}
            {% endwith %}

            <span class="badge rounded-pill text-bg-secondary px-3 py-2">
              Registro: <strong class="ms-1">{{ objeto_lugar.fecha|date:"d/m/Y" }}</strong>
            </span>
          </div>

          <div class="alert alert-light border rounded-4 mb-0">
            <div class="fw-semibold mb-1">Cómo leer esta pantalla</div>
            <div class="small text-muted">
              Arriba se muestra el estado actual del objeto en este lugar. Abajo verás el histórico con estados anteriores.
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="card-header bg-white border-0 p-3 p-md-4">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div>
          <div class="fw-bold">Histórico de cambios</div>
          <div class="text-muted small">Registros anteriores del mismo objeto en este lugar</div>
        </div>
        <span class="badge rounded-pill text-bg-light border px-3 py-2">
          Registros: <strong class="ms-1">{{ historicos|length }}</strong>
        </span>
      </div>
    </div>

    <div class="card-body p-0">
      {% if historicos %}
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:110px;">Cant. anterior</th>
                <th style="width:160px;">Estado anterior</th>
                <th>Detalle anterior</th>
                <th style="width:140px;">Fecha anterior</th>
                <th class="text-end" style="width:120px;">Acción</th>
              </tr>
            </thead>
            <tbody>
              {% for h in historicos %}
              <tr>
                <td class="fw-semibold">{{ h.cantidad_anterior }}</td>
                <td>
                  {% with e=h.get_estado_anterior_display %}
                    {% if e == "Bueno" %}
                      <span class="badge bg-success">Bueno</span>
                    {% elif e == "Pendiente" %}
                      <span class="badge bg-warning text-dark">Pendiente</span>
                    {% else %}
                      <span class="badge bg-danger">Malo</span>
                    {% endif %}
                  {% endwith %}
                </td>
                <td class="text-muted">
                  {% if h.detalle_anterior %}{{ h.detalle_anterior }}{% else %}—{% endif %}
                </td>
                <td>{{ h.fecha_anterior|date:"d/m/Y" }}</td>
                <td class="text-end">
                  <a class="btn btn-outline-primary btn-sm" href="{% url 'detalle_historico' historico_id=h.id %}">Ver</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="p-3 p-md-4 border-top bg-white">
          <div class="small text-muted">Nota: el histórico se crea automáticamente cuando cambias cantidad, estado o detalle.</div>
        </div>
      {% else %}
        <div class="p-4">
          <div class="alert alert-secondary mb-0 rounded-4">No hay registros históricos para este objeto en este lugar.</div>
        </div>
      {% endif %}
    </div>
  </div>

  {# ===== MODAL CONFIRMAR BORRADO ===== #}
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar borrado</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">¿Seguro que quieres borrar:</div>
          <div class="fw-semibold" id="deleteTargetName">—</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <form method="post" id="deleteForm" action="#">
            {% csrf_token %}
            <button class="btn btn-danger" type="submit">Sí, borrar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  {# ===== MODAL BLOQUEADO (RELACIONES) ===== #}
  <div class="modal fade" id="blockedDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">No se puede borrar</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          Este elemento aún tiene cosas ligadas. Primero elimina o desvincula lo relacionado y vuelve a intentar.
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const confirmModal = document.getElementById("confirmDeleteModal");
  const deleteForm = document.getElementById("deleteForm");
  const nameEl = document.getElementById("deleteTargetName");

  if (confirmModal) {
    confirmModal.addEventListener("show.bs.modal", function (event) {
      const btn = event.relatedTarget;
      const url = btn?.getAttribute("data-delete-url") || "#";
      const name = btn?.getAttribute("data-delete-name") || "—";
      if (deleteForm) deleteForm.action = url;
      if (nameEl) nameEl.textContent = name;
    });
  }

  const params = new URLSearchParams(window.location.search);
  if (params.get("blocked") === "1") {
    const blocked = document.getElementById("blockedDeleteModal");
    if (blocked && typeof bootstrap !== "undefined") {
      new bootstrap.Modal(blocked).show();
    }
  }
});
</script>
{% endblock %}
