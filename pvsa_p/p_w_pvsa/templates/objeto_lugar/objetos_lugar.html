{# templates/objeto_lugar/objetos_lugar.html #}
{% extends "base.html" %}
{% block content %}
<div class="container-xxl py-4" style="max-width: 1280px;">

  <!-- Header -->
  <div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-3">
    <div>
      <h1 class="h4 fw-bold mb-1">Objetos del lugar</h1>
      <div class="text-muted">
        Aquí ves los objetos registrados por lugar. Usa los filtros para encontrar rápido lo que buscas.
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2">
      <a href="{% url 'lista_objetos_lugar' %}" class="btn btn-outline-secondary btn-sm">
        Limpiar filtros
      </a>
    </div>
  </div>

  <!-- Info rápida (cómo leer) -->
  <div class="alert alert-light border rounded-4 mb-3">
    <div class="row g-2">
      <div class="col-12 col-lg-8">
        <div class="fw-semibold">Cómo leer esta tabla</div>
        <div class="text-muted small">
          Cada fila es un objeto registrado dentro de un lugar específico. El estado puede ser Bueno, Pendiente o Malo.
          El botón “Ver” abre el detalle del registro (incluye histórico si existe).
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
          {% if lugar_actual or objeto_actual or tipo_actual or estado_actual %}
            <span class="badge rounded-pill text-bg-primary px-3 py-2">Vista filtrada</span>
          {% else %}
            <span class="badge rounded-pill text-bg-light border px-3 py-2">Mostrando todo</span>
          {% endif %}
          <span class="badge rounded-pill text-bg-light border px-3 py-2">
            Registros: <strong class="ms-1">{{ objetos|length }}</strong>
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">

    <!-- Filtros -->
    <div class="col-12 col-lg-4 col-xl-3">
      <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-header bg-white border-0 p-3">
          <div class="fw-bold">Filtros</div>
          <div class="text-muted small">Aplica uno o varios filtros</div>
        </div>

        <div class="card-body p-3 p-md-4">
          <form method="get" class="vstack gap-3">

            <div>
              <label for="id_filtro_lugar" class="form-label small text-muted mb-1">Lugar</label>
              <select id="id_filtro_lugar" name="lugar" class="form-select form-select-sm">
                <option value="">Todos los lugares</option>
                {% for l in lugares %}
                  <option value="{{ l.id }}" {% if lugar_actual == l.id|stringformat:'s' %}selected{% endif %}>
                    {{ l.nombre_del_lugar }} · Piso {{ l.piso.piso }} · {{ l.piso.ubicacion.ubicacion }} · Sector {{ l.piso.ubicacion.sector.sector }}
                  </option>
                {% endfor %}
              </select>
              <div class="form-text">Filtra por el lugar exacto donde está el objeto.</div>
            </div>

            <div>
              <label for="id_filtro_objeto" class="form-label small text-muted mb-1">Objeto</label>
              <select id="id_filtro_objeto" name="objeto" class="form-select form-select-sm">
                <option value="">Todos los objetos</option>
                {% for obj in objetos_catalogo %}
                  <option value="{{ obj.id }}" {% if objeto_actual == obj.id|stringformat:'s' %}selected{% endif %}>
                    {{ obj.nombre_del_objeto }} · {{ obj.objeto_categoria.nombre_de_categoria|default:obj.objeto_categoria }}
                  </option>
                {% endfor %}
              </select>
              <div class="form-text">Filtra por el nombre del objeto (sin importar marca/material).</div>
            </div>

            <div>
              <label for="id_filtro_tipo" class="form-label small text-muted mb-1">Tipo de objeto (marca/material)</label>
              <select id="id_filtro_tipo" name="tipo" class="form-select form-select-sm">
                <option value="">Todos los tipos</option>
                {% for t in tipos %}
                  <option value="{{ t.id }}" {% if tipo_actual == t.id|stringformat:'s' %}selected{% endif %}>
                    {{ t.objeto.nombre_del_objeto }} ·
                    {% if t.marca %}{{ t.marca }}{% else %}Sin marca{% endif %}
                    {% if t.material %} / {{ t.material }}{% else %} / Sin material{% endif %}
                  </option>
                {% endfor %}
              </select>
              <div class="form-text">Más específico: mismo objeto, pero con marca/material distinto.</div>
            </div>

            <div>
              <label for="id_filtro_estado" class="form-label small text-muted mb-1">Estado</label>
              <select id="id_filtro_estado" name="estado" class="form-select form-select-sm">
                <option value="">Todos los estados</option>
                {% for value, label in estados %}
                  <option value="{{ value }}" {% if estado_actual == value|stringformat:'s' %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
              <div class="form-text">Bueno, Pendiente o Malo.</div>
            </div>

            <button type="submit" class="btn btn-primary w-100">
              Aplicar filtros
            </button>

          </form>
        </div>
      </div>
    </div>

    <!-- Resultados -->
    <div class="col-12 col-lg-8 col-xl-9">
      <div class="card border-0 shadow-sm rounded-4 overflow-hidden">

        <div class="card-header bg-white border-0 p-3 p-md-4">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
            <div>
              <div class="fw-bold">Resultados</div>
              <div class="text-muted small">
                {% if lugar_actual or objeto_actual or tipo_actual or estado_actual %}
                  Mostrando resultados según filtros seleccionados.
                {% else %}
                  Mostrando todo el registro (sin filtros).
                {% endif %}
              </div>
            </div>

            {% if lugar_actual or objeto_actual or tipo_actual or estado_actual %}
              <span class="badge rounded-pill text-bg-light border px-3 py-2">
                Filtros activos
              </span>
            {% endif %}
          </div>
        </div>

        <div class="card-body p-0">
          {% if objetos %}
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="min-width:300px;">Ubicación del registro</th>
                    <th style="min-width:240px;">Objeto</th>
                    <th style="min-width:220px;">Tipo (marca / material)</th>
                    <th class="text-center" style="width:90px;">Cant.</th>
                    <th style="width:140px;">Estado</th>
                    <th style="width:120px;">Fecha</th>
                    <th class="text-end" style="width:110px;">Acción</th>
                  </tr>
                </thead>

                <tbody>
                  {% for o in objetos %}
                  <tr>
                    <td>
                      <div class="fw-semibold">
                        {% if o.lugar %}{{ o.lugar.nombre_del_lugar }}{% else %}Sin lugar{% endif %}
                      </div>
                      <div class="text-muted small">
                        {% if o.lugar %}
                          Sector {{ o.lugar.piso.ubicacion.sector.sector }} ·
                          {{ o.lugar.piso.ubicacion.ubicacion }} ·
                          Piso {{ o.lugar.piso.piso }}
                        {% else %}
                          —
                        {% endif %}
                      </div>
                    </td>

                    <td>
                      <div class="fw-semibold">
                        {% if o.tipo_de_objeto and o.tipo_de_objeto.objeto %}
                          {{ o.tipo_de_objeto.objeto.nombre_del_objeto }}
                        {% else %}
                          —
                        {% endif %}
                      </div>
                      <div class="text-muted small">
                        {% if o.tipo_de_objeto and o.tipo_de_objeto.objeto and o.tipo_de_objeto.objeto.objeto_categoria %}
                          Categoría: {{ o.tipo_de_objeto.objeto.objeto_categoria.nombre_de_categoria }}
                        {% else %}
                          Categoría: —
                        {% endif %}
                      </div>
                    </td>

                    <td>
                      <div class="fw-semibold">
                        {% if o.tipo_de_objeto %}
                          {% if o.tipo_de_objeto.marca %}{{ o.tipo_de_objeto.marca }}{% else %}Sin marca{% endif %}
                        {% else %}
                          —
                        {% endif %}
                      </div>
                      <div class="text-muted small">
                        Material:
                        {% if o.tipo_de_objeto and o.tipo_de_objeto.material %}
                          {{ o.tipo_de_objeto.material }}
                        {% else %}
                          Sin material
                        {% endif %}
                      </div>
                    </td>

                    <td class="text-center fw-semibold">{{ o.cantidad }}</td>

                    <td>
                      {% with est=o.get_estado_display %}
                        {% if est == "Bueno" %}
                          <span class="badge bg-success">Bueno</span>
                        {% elif est == "Pendiente" %}
                          <span class="badge bg-warning text-dark">Pendiente</span>
                        {% else %}
                          <span class="badge bg-danger">Malo</span>
                        {% endif %}
                      {% endwith %}
                    </td>

                    <td>{{ o.fecha|date:"d/m/Y" }}</td>

                    <td class="text-end">
                      <a class="btn btn-outline-primary btn-sm" href="{% url 'detalle_objeto_lugar' objeto_lugar_id=o.id %}">
                        Ver
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>

              </table>
            </div>
          {% else %}
            <div class="p-4">
              <div class="alert alert-secondary mb-0 rounded-4">
                No hay registros
                {% if lugar_actual or objeto_actual or tipo_actual or estado_actual %}
                  para los filtros seleccionados.
                {% else %}
                  aún.
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div>

      </div>
    </div>

  </div>
</div>
{% endblock %}
