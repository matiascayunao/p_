{% extends "base.html" %}
{% block content %}
<div class="container-xxl py-4" style="max-width:1280px;">

  <div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-3">
    <div>
      <h1 class="h4 fw-bold mb-1">Tipos de objeto</h1>
      <div class="text-muted">Listado de tipos (objeto + marca/material).</div>
    </div>
    <a href="{% url 'crear_tipo_objeto' %}" class="btn btn-primary">+ Crear</a>
  </div>

  <form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-md-4">
      <label for="id_categoria_filtro" class="form-label small text-muted mb-1">Categoría</label>
      <select name="categoria" id="id_categoria_filtro" class="form-select">
        <option value="">Todas las categorías</option>
        {% for c in categorias %}
          <option value="{{ c.id }}" {% if categoria_actual == c.id|stringformat:'s' %}selected{% endif %}>
            {{ c.nombre_de_categoria }}
          </option>
        {% endfor %}
      </select>
      <div class="form-text">Primero puedes elegir una categoría.</div>
    </div>

    <div class="col-md-4">
      <label for="id_objeto_filtro" class="form-label small text-muted mb-1">Objeto</label>
      <select name="objeto" id="id_objeto_filtro" class="form-select">
        <option value="">Todos los objetos</option>
        {% for o in objetos %}
          <option value="{{ o.id }}" data-categoria="{{ o.objeto_categoria_id }}"
                  {% if objeto_actual == o.id|stringformat:'s' %}selected{% endif %}>
            {{ o.nombre_del_objeto }} ({{ o.objeto_categoria.nombre_de_categoria }})
          </option>
        {% endfor %}
      </select>
      <div class="form-text">Opcional: acota a un objeto específico.</div>
    </div>

    <div class="col-md-2 d-grid">
      <button type="submit" class="btn btn-outline-secondary">Aplicar</button>
    </div>

    <div class="col-md-2 d-grid">
      <a class="btn btn-outline-secondary" href="{% url 'lista_tipos_objeto' %}">Limpiar</a>
    </div>
  </form>

  <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="card-header bg-white border-0 p-3 p-md-4">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div>
          <div class="fw-bold">Resultados</div>
          <div class="text-muted small">Selecciona un tipo para ver detalle y dónde se usa.</div>
        </div>
        <span class="badge rounded-pill text-bg-light border px-3 py-2">
          Registros: <strong class="ms-1">{{ tipos_objeto|length }}</strong>
        </span>
      </div>
    </div>

    <div class="card-body p-0">
      {% if tipos_objeto %}
        <div class="list-group list-group-flush">
          {% for t in tipos_objeto %}
            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
               href="{% url 'detalle_tipo_objeto' tipo_objeto_id=t.id %}">
              <div>
                <div class="fw-semibold">{{ t.objeto.nombre_del_objeto }}</div>
                <div class="text-muted small">
                  {{ t.objeto.objeto_categoria.nombre_de_categoria }} ·
                  {% if t.marca %}{{ t.marca }}{% else %}Sin marca{% endif %}
                  · {% if t.material %}{{ t.material }}{% else %}Sin material{% endif %}
                </div>
              </div>
              <span class="text-muted">Ver &raquo;</span>
            </a>
          {% endfor %}
        </div>
      {% else %}
        <div class="p-4">
          <div class="alert alert-secondary mb-0 rounded-4">
            No hay tipos de objeto registrados{% if categoria_actual or objeto_actual %} para el filtro seleccionado{% endif %}.
          </div>
        </div>
      {% endif %}
    </div>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const categoriaSelect = document.getElementById("id_categoria_filtro");
  const objetoSelect = document.getElementById("id_objeto_filtro");
  if (!categoriaSelect || !objetoSelect) return;

  function filtrarObjetosPorCategoria() {
    const categoriaId = categoriaSelect.value;
    let ok = false;

    Array.from(objetoSelect.options).forEach(function (opt) {
      if (opt.value === "") { opt.hidden = false; return; }
      const optCategoria = opt.dataset.categoria;

      if (!categoriaId || optCategoria === categoriaId) {
        opt.hidden = false;
        if (objetoSelect.value === opt.value) ok = true;
      } else {
        opt.hidden = true;
      }
    });

    if (!ok) objetoSelect.value = "";
  }

  filtrarObjetosPorCategoria();
  categoriaSelect.addEventListener("change", filtrarObjetosPorCategoria);
});
</script>
{% endblock %}