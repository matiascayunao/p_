{% extends "base.html" %}

{% block content %}
<div class="container-xxl py-4" style="max-width: 1280px;">
  <!-- Header -->
  <div class="d-flex flex-wrap align-items-start align-items-md-center justify-content-between gap-2 mb-3">
    <div>
      <h2 class="mb-1 fw-bold">Carga masiva</h2>
      <div class="text-muted">Subir Excel ‚Üí previsualizar/editar ‚Üí guardar en el sistema</div>
    </div>

    <div class="d-flex gap-2">
      <a href="javascript:history.back()" class="btn btn-outline-secondary">
        ‚Üê Volver
      </a>
      {% if step != "upload" %}
        <a href="{% url 'carga_masiva' %}" class="btn btn-outline-secondary">
          Volver a subir
        </a>
      {% endif %}
    </div>
  </div>

  <!-- Stepper -->
  <div class="card border-0 shadow-sm rounded-4 mb-3">
    <div class="card-body py-3">
      <div class="d-flex flex-wrap align-items-center gap-2">
        <span class="stepchip {% if step == 'upload' %}active{% endif %}">
          <span class="dot">1</span> Subir Excel
        </span>
        <span class="stepsep">‚Üí</span>
        <span class="stepchip {% if step != 'upload' %}active{% endif %}">
          <span class="dot">2</span> Revisar / Editar
        </span>
        <span class="stepsep">‚Üí</span>
        <span class="stepchip {% if step != 'upload' %}active{% endif %}">
          <span class="dot">3</span> Guardar
        </span>

        <div class="ms-auto d-flex flex-wrap gap-2 align-items-center">
          {% if step != "upload" %}
            {% if detected %}
              <span class="badge rounded-pill text-bg-secondary px-3 py-2">
                Detectado: {{ detected }}
              </span>
            {% endif %}
            <span class="badge rounded-pill text-bg-light border px-3 py-2">
              Filas: <strong class="ms-1">{{ payload.objetos_lugar|length }}</strong>
            </span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Alerts -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show rounded-4" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
      </div>
    {% endfor %}
  {% endif %}

  {% if error %}
    <div class="alert alert-danger alert-dismissible fade show rounded-4" role="alert">
      {{ error }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
  {% endif %}

  {% if step == "upload" %}
    <!-- Upload -->
    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-body p-4 p-md-5">
        <div class="d-flex align-items-start gap-3 mb-3">
          <div class="iconwrap">
            <!-- simple inline icon -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 3v10m0-10 4 4m-4-4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M4 15v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <h5 class="mb-1 fw-semibold">Sube tu Excel</h5>
            <div class="text-muted">
              Puedes cargar <strong>plantilla normalizada</strong> o un <strong>Excel exportado por tu sistema</strong>.
              Luego podr√°s revisar/editar antes de guardar.
            </div>
          </div>
        </div>

        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}

          <input type="file" id="id_archivo" name="archivo" accept=".xlsx,.xls" class="d-none">

          <div id="dropzone" class="dropzone rounded-4 mb-3" tabindex="0" role="button" aria-label="Subir Excel">
            <div class="dz-inner">
              <div class="dz-title">Haz click o arrastra tu archivo aqu√≠</div>
              <div class="dz-sub text-muted">
                Formatos: <code>.xlsx</code>, <code>.xls</code>
              </div>

              <div class="dz-meta mt-3">
                <div class="dz-pill">
                  <span class="dz-pill-dot"></span>
                  <span id="dz-status">Sin archivo seleccionado</span>
                </div>
                <div id="dz-filename" class="dz-filename"></div>
              </div>

              <div class="dz-actions mt-3 d-flex gap-2 justify-content-center flex-wrap">
                <button type="button" class="btn btn-outline-secondary" id="btnPick">
                  Elegir archivo
                </button>
                <button type="button" class="btn btn-outline-danger d-none" id="btnClear">
                  Quitar
                </button>
              </div>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 align-items-center">
            <button type="submit" class="btn btn-primary px-4" id="btnUpload" disabled>
              Cargar y previsualizar
            </button>
            <span class="text-muted small">
              Tip: si el Excel trae ‚ÄúSin categor√≠a / Sin especificaci√≥n‚Äù, puedes corregirlo en la previsualizaci√≥n.
            </span>
          </div>
        </form>
      </div>
    </div>

  {% else %}
    <!-- Preview -->
    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-body p-3 p-md-4">

        <!-- Toolbar -->
        <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <div class="fw-semibold">Previsualizaci√≥n</div>
            <span class="text-muted small">Edita lo necesario antes de guardar</span>
          </div>

          <div class="d-flex flex-wrap gap-2 align-items-center">
            <div class="input-group">
              <span class="input-group-text bg-white">üîé</span>
              <input id="tableFilter" type="text" class="form-control" placeholder="Filtrar filas (ubicaci√≥n, sector, objeto, etc.)">
            </div>

            <div class="text-muted small">
              Mostrando: <span id="rowsShown">0</span> / {{ payload.objetos_lugar|length }}
            </div>
          </div>
        </div>

        <form id="importForm" method="post">
          {% csrf_token %}
          <input type="hidden" name="payload_json" id="payload_json">

          <div class="tablewrap rounded-4 border">
            <div class="table-responsive" style="max-height: 68vh;">
              <table class="table table-hover align-middle mb-0" id="tablaObjetosLugar">
                <thead class="table-light sticky-top">
                  <tr>
                    <th class="th-min">Ubicaci√≥n</th>
                    <th class="th-min">Sector</th>
                    <th class="th-min">Piso</th>
                    <th class="th-med">Tipo de lugar</th>
                    <th class="th-med">Lugar</th>
                    <th class="th-med">Categor√≠a</th>
                    <th class="th-med">Objeto</th>
                    <th class="th-med">Tipo</th>
                    <th class="th-xs text-center">Cantidad</th>
                    <th class="th-sm">Estado</th>
                    <th class="th-lg">Detalle</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in payload.objetos_lugar %}
                    <tr class="rowedit">
                      <td>
                        <input class="form-control form-control-sm inputflat" data-k="ubicacion"
                               value="{{ r.ubicacion|default_if_none:'' }}">
                      </td>
                      <td>
                        <input class="form-control form-control-sm inputflat" data-k="sector"
                               value="{{ r.sector|default_if_none:'' }}">
                      </td>
                      <td>
                        <input class="form-control form-control-sm inputflat" data-k="piso"
                               value="{{ r.piso|default_if_none:'' }}">
                      </td>
                      <td>
                        <input class="form-control form-control-sm inputflat" data-k="tipo_de_lugar"
                               value="{{ r.tipo_de_lugar|default_if_none:'' }}">
                      </td>
                      <td>
                        <input class="form-control form-control-sm inputflat" data-k="lugar"
                               value="{{ r.lugar|default_if_none:'' }}">
                      </td>
                      <td>
                        <input class="form-control form-control-sm inputflat" data-k="categoria"
                               value="{{ r.categoria|default_if_none:'' }}">
                      </td>
                      <td>
                        <input class="form-control form-control-sm inputflat" data-k="objeto"
                               value="{{ r.objeto|default_if_none:'' }}">
                      </td>
                      <td>
                        <input class="form-control form-control-sm inputflat" data-k="tipo_objeto"
                               value="{{ r.tipo_objeto|default_if_none:'' }}">
                      </td>
                      <td>
                        <input class="form-control form-control-sm inputflat text-center" data-k="cantidad"
                               type="number" min="0" value="{{ r.cantidad|default_if_none:0 }}">
                      </td>
                      <td>
                        <select class="form-select form-select-sm inputflat estadoSel" data-k="estado">
                          {% with est=r.estado|default_if_none:'' %}
                            <option value="" {% if est == "" %}selected{% endif %}></option>
                            <option value="Bueno" {% if est == "Bueno" %}selected{% endif %}>Bueno</option>
                            <option value="Pendiente" {% if est == "Pendiente" %}selected{% endif %}>Pendiente</option>
                            <option value="Malo" {% if est == "Malo" %}selected{% endif %}>Malo</option>
                          {% endwith %}
                        </select>
                      </td>
                      <td>
                        <input class="form-control form-control-sm inputflat" data-k="detalle"
                               value="{{ r.detalle|default_if_none:'' }}">
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <!-- Footer actions -->
          <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mt-3">
            <div class="text-muted small">
              Consejo: puedes usar el filtro üîé para encontrar r√°pido un lugar u objeto.
            </div>

            <div class="d-flex gap-2">
              <a href="{% url 'carga_masiva' %}" class="btn btn-outline-secondary">
                Volver a subir
              </a>

              <button type="button" id="btnGuardar" class="btn btn-success px-4">
                <span class="btnLabel">Guardar en sistema</span>
                <span class="spinner-border spinner-border-sm ms-2 d-none" id="saveSpinner" role="status" aria-hidden="true"></span>
              </button>
            </div>
          </div>
        </form>

      </div>
    </div>
  {% endif %}
</div>

<style>
  /* ---- general polish ---- */
  .rounded-4 { border-radius: 1rem !important; }
  .iconwrap{
    width: 42px; height: 42px;
    border-radius: 12px;
    display: grid; place-items: center;
    background: rgba(13,110,253,.10);
    color: #0d6efd;
    flex: 0 0 auto;
  }

  /* ---- stepper ---- */
  .stepchip{
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: .45rem .75rem;
    border: 1px solid rgba(0,0,0,.10);
    border-radius: 999px;
    background: #fff;
    color: #6c757d;
    font-weight: 600;
    font-size: .95rem;
  }
  .stepchip .dot{
    width: 26px; height: 26px;
    border-radius: 999px;
    display: grid; place-items: center;
    border: 1px solid rgba(0,0,0,.15);
    font-weight: 800;
    font-size: .9rem;
    background: #fff;
    color: #6c757d;
  }
  .stepchip.active{
    color: #0b5ed7;
    border-color: rgba(13,110,253,.35);
    background: rgba(13,110,253,.06);
  }
  .stepchip.active .dot{
    color: #0b5ed7;
    border-color: rgba(13,110,253,.35);
    background: rgba(13,110,253,.10);
  }
  .stepsep{ color: #adb5bd; font-weight: 700; }

  /* ---- dropzone ---- */
  .dropzone{
    border: 2px dashed rgba(0,0,0,.22);
    background: linear-gradient(180deg, rgba(13,110,253,.04), rgba(13,110,253,0));
    min-height: 280px;
    display: grid;
    place-items: center;
    padding: 22px;
    cursor: pointer;
    user-select: none;
    transition: transform .08s ease, border-color .12s ease, background .12s ease;
  }
  .dropzone:hover{ transform: translateY(-1px); }
  .dropzone:focus{ outline: none; box-shadow: 0 0 0 .25rem rgba(13,110,253,.18); }
  .dropzone.dragover{
    border-color: rgba(13,110,253,.7);
    background: rgba(13,110,253,.08);
  }
  .dz-inner{ text-align: center; max-width: 640px; }
  .dz-title{ font-weight: 800; font-size: 1.1rem; margin-bottom: .25rem; }
  .dz-meta{ display: grid; gap: .25rem; justify-items: center; }
  .dz-pill{
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: .35rem .6rem;
    border-radius: 999px;
    border: 1px solid rgba(0,0,0,.12);
    background: #fff;
    font-size: .92rem;
  }
  .dz-pill-dot{
    width: 10px; height: 10px; border-radius: 999px;
    background: #adb5bd;
  }
  .dz-filename{
    font-weight: 700;
    color: #212529;
    word-break: break-word;
  }

  /* ---- table polish ---- */
  .tablewrap{ background: #fff; overflow: hidden; }
  #tablaObjetosLugar thead th{
    font-size: .82rem;
    text-transform: uppercase;
    letter-spacing: .04em;
    color: #495057;
    white-space: nowrap;
  }
  .rowedit{ transition: background .08s ease; }
  .rowedit:focus-within{
    background: rgba(13,110,253,.06) !important;
  }
  .inputflat{
    border-radius: .65rem !important;
    border-color: rgba(0,0,0,.10) !important;
  }
  .inputflat:focus{
    border-color: rgba(13,110,253,.55) !important;
    box-shadow: 0 0 0 .2rem rgba(13,110,253,.14) !important;
  }

  /* column sizing */
  .th-xs{ width: 95px; }
  .th-sm{ width: 150px; }
  .th-min{ min-width: 130px; }
  .th-med{ min-width: 170px; }
  .th-lg{ min-width: 220px; }

  /* estado coloring */
  .estado-good{ background: rgba(25,135,84,.10) !important; border-color: rgba(25,135,84,.25) !important; }
  .estado-pend{ background: rgba(255,193,7,.12) !important; border-color: rgba(255,193,7,.30) !important; }
  .estado-bad { background: rgba(220,53,69,.10) !important; border-color: rgba(220,53,69,.25) !important; }
</style>

<script>
(function(){
  // --- Upload (dropzone) ---
  const dz = document.getElementById("dropzone");
  const input = document.getElementById("id_archivo");
  const filename = document.getElementById("dz-filename");
  const status = document.getElementById("dz-status");
  const btnPick = document.getElementById("btnPick");
  const btnClear = document.getElementById("btnClear");
  const btnUpload = document.getElementById("btnUpload");

  function setUploadState(){
    const has = input && input.files && input.files.length;
    if (!status) return;
    if (has){
      status.textContent = "Archivo listo para subir";
      if (filename) filename.textContent = input.files[0].name;
      const dot = document.querySelector(".dz-pill-dot");
      if (dot) dot.style.background = "#198754";
      if (btnClear) btnClear.classList.remove("d-none");
      if (btnUpload) btnUpload.disabled = false;
    } else {
      status.textContent = "Sin archivo seleccionado";
      if (filename) filename.textContent = "";
      const dot = document.querySelector(".dz-pill-dot");
      if (dot) dot.style.background = "#adb5bd";
      if (btnClear) btnClear.classList.add("d-none");
      if (btnUpload) btnUpload.disabled = true;
    }
  }

  if (dz && input) {
    const openPicker = () => input.click();

    dz.addEventListener("click", openPicker);
    dz.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openPicker(); }
    });

    if (btnPick) btnPick.addEventListener("click", (e) => { e.preventDefault(); openPicker(); });

    input.addEventListener("change", setUploadState);

    if (btnClear){
      btnClear.addEventListener("click", (e) => {
        e.preventDefault();
        input.value = "";
        setUploadState();
      });
    }

    dz.addEventListener("dragover", (e) => {
      e.preventDefault();
      dz.classList.add("dragover");
    });
    dz.addEventListener("dragleave", () => dz.classList.remove("dragover"));
    dz.addEventListener("drop", (e) => {
      e.preventDefault();
      dz.classList.remove("dragover");
      if (!e.dataTransfer.files || !e.dataTransfer.files.length) return;

      const dt = new DataTransfer();
      for (const f of e.dataTransfer.files) dt.items.add(f);
      input.files = dt.files;

      setUploadState();
    });

    setUploadState();
  }

  // --- Preview: filter + estado coloring + save payload ---
  const tabla = document.getElementById("tablaObjetosLugar");
  const filter = document.getElementById("tableFilter");
  const rowsShown = document.getElementById("rowsShown");

  function paintEstado(select){
    if (!select) return;
    select.classList.remove("estado-good","estado-pend","estado-bad");
    const v = (select.value || "").trim();
    if (v === "Bueno") select.classList.add("estado-good");
    if (v === "Pendiente") select.classList.add("estado-pend");
    if (v === "Malo") select.classList.add("estado-bad");
  }

  function updateRowsShown(){
    if (!tabla || !rowsShown) return;
    const trs = tabla.querySelectorAll("tbody tr");
    let visible = 0;
    trs.forEach(tr => {
      if (tr.style.display !== "none") visible++;
    });
    rowsShown.textContent = visible;
  }

  if (tabla){
    tabla.querySelectorAll("select.estadoSel").forEach(sel => {
      paintEstado(sel);
      sel.addEventListener("change", () => paintEstado(sel));
    });
    updateRowsShown();
  }

  if (tabla && filter){
    filter.addEventListener("input", () => {
      const q = (filter.value || "").trim().toLowerCase();
      const trs = tabla.querySelectorAll("tbody tr");
      trs.forEach(tr => {
        const text = tr.innerText.toLowerCase();
        tr.style.display = (!q || text.includes(q)) ? "" : "none";
      });
      updateRowsShown();
    });
  }

  const btnGuardar = document.getElementById("btnGuardar");
  const payloadInput = document.getElementById("payload_json");
  const form = document.getElementById("importForm");
  const spinner = document.getElementById("saveSpinner");
  const btnLabel = btnGuardar ? btnGuardar.querySelector(".btnLabel") : null;

  if (btnGuardar && tabla && payloadInput && form) {
    btnGuardar.addEventListener("click", () => {
      // UX: prevent double submit
      btnGuardar.disabled = true;
      if (spinner) spinner.classList.remove("d-none");
      if (btnLabel) btnLabel.textContent = "Guardando...";

      const rows = [];
      const trs = tabla.querySelectorAll("tbody tr");

      trs.forEach(tr => {
        // si usas filtro, igual guardamos TODO (incluye ocultas). Si quieres guardar solo visibles, av√≠same.
        const obj = {};
        tr.querySelectorAll("[data-k]").forEach(el => {
          const k = el.getAttribute("data-k");
          let v = (el.value ?? "").trim();
          if (k === "cantidad") {
            const n = parseInt(v || "0", 10);
            v = Number.isFinite(n) ? n : 0;
          }
          obj[k] = v;
        });
        rows.push(obj);
      });

      payloadInput.value = JSON.stringify({ objetos_lugar: rows });
      form.submit();
    });
  }
})();
</script>
{% endblock %}