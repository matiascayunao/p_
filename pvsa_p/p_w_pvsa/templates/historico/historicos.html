{% extends "base.html" %}
{% block content %}
<div class="container-xxl py-4" style="max-width: 1280px;">

  <div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-3">
    <div>
      <h2 class="h4 fw-bold mb-1">Históricos</h2>
      <div class="text-muted">Cambios registrados en objetos (cantidad, estado o detalle).</div>
    </div>

    <div class="d-flex gap-2">
      <a href="{% url 'lista_historicos' %}" class="btn btn-outline-secondary btn-sm">
        Limpiar filtros
      </a>
      <span class="badge rounded-pill text-bg-light border px-3 py-2">
        Registros: <strong class="ms-1">{{ historicos|length }}</strong>
      </span>
    </div>
  </div>

  <div class="row g-3">
    <!-- Filtros -->
    <div class="col-12 col-lg-4 col-xl-3">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body p-3 p-md-4">
          <div class="fw-semibold mb-1">Filtros</div>
          <div class="text-muted small mb-3">Refina la búsqueda y ubica el cambio rápidamente.</div>

          <form method="get" class="vstack gap-3">
            <div>
              <label for="id_filtro_lugar" class="form-label small text-muted mb-1">Lugar</label>
              <select id="id_filtro_lugar" name="lugar" class="form-select form-select-sm">
                <option value="">Todos</option>
                {% for l in lugares %}
                  <option value="{{ l.id }}" {% if lugar_actual == l.id|stringformat:'s' %}selected{% endif %}>
                    {{ l.nombre_del_lugar }} – Piso {{ l.piso.piso }} – {{ l.piso.ubicacion.ubicacion }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div>
              <label for="id_filtro_objeto" class="form-label small text-muted mb-1">Objeto</label>
              <select id="id_filtro_objeto" name="objeto" class="form-select form-select-sm">
                <option value="">Todos</option>
                {% for obj in objetos_catalogo %}
                  <option value="{{ obj.id }}" {% if objeto_actual == obj.id|stringformat:'s' %}selected{% endif %}>
                    {{ obj.nombre_del_objeto }} ({{ obj.objeto_categoria.nombre_de_categoria }})
                  </option>
                {% endfor %}
              </select>
            </div>

            <div>
              <label for="id_filtro_tipo" class="form-label small text-muted mb-1">Tipo de objeto</label>
              <select id="id_filtro_tipo" name="tipo" class="form-select form-select-sm">
                <option value="">Todos</option>
                {% for t in tipos %}
                  <option value="{{ t.id }}" {% if tipo_actual == t.id|stringformat:'s' %}selected{% endif %}>
                    {{ t.objeto.nombre_del_objeto }} – {{ t.marca }} {{ t.material }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div>
              <label for="id_filtro_estado" class="form-label small text-muted mb-1">Estado anterior</label>
              <select id="id_filtro_estado" name="estado" class="form-select form-select-sm">
                <option value="">Todos</option>
                {% for value, label in estados %}
                  <option value="{{ value }}" {% if estado_actual == value|stringformat:'s' %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <button type="submit" class="btn btn-primary w-100">Aplicar</button>
          </form>

        </div>
      </div>
    </div>

    <!-- Resultados -->
    <div class="col-12 col-lg-8 col-xl-9">
      <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body p-0">
          {% if historicos %}
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="min-width: 360px;">Lugar / Objeto</th>
                    <th class="text-center" style="width: 110px;">Cant.</th>
                    <th style="width: 140px;">Estado</th>
                    <th style="min-width: 220px;">Detalle</th>
                    <th style="width: 120px;">Fecha</th>
                    <th class="text-end" style="width: 240px;">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for h in historicos %}
                  <tr>
                    <td>
                      <div class="fw-semibold">{{ h.objeto_del_lugar.lugar.nombre_del_lugar }}</div>
                      <div class="text-muted small">
                        Piso {{ h.objeto_del_lugar.lugar.piso.piso }} ·
                        {{ h.objeto_del_lugar.lugar.piso.ubicacion.ubicacion }} ·
                        {{ h.objeto_del_lugar.lugar.piso.ubicacion.sector.sector }}
                      </div>
                      <div class="small mt-1">
                        <span class="text-muted">Objeto:</span>
                        {{ h.objeto_del_lugar.tipo_de_objeto.objeto.nombre_del_objeto }}
                        · <span class="text-muted">Categoría:</span>
                        {{ h.objeto_del_lugar.tipo_de_objeto.objeto.objeto_categoria.nombre_de_categoria }}
                      </div>
                      <div class="text-muted small">
                        Tipo: {{ h.objeto_del_lugar.tipo_de_objeto.marca|default:"—" }}
                        {{ h.objeto_del_lugar.tipo_de_objeto.material|default:"" }}
                      </div>
                    </td>

                    <td class="text-center fw-semibold">{{ h.cantidad_anterior }}</td>

                    <td>
                      {% if h.estado_anterior == "B" %}
                        <span class="badge bg-success">Bueno</span>
                      {% elif h.estado_anterior == "P" %}
                        <span class="badge bg-warning text-dark">Pendiente</span>
                      {% else %}
                        <span class="badge bg-danger">Malo</span>
                      {% endif %}
                    </td>

                    <td class="text-muted">
                      {% if h.detalle_anterior %}
                        {{ h.detalle_anterior }}
                      {% else %}
                        —
                      {% endif %}
                    </td>

                    <td>{{ h.fecha_anterior|date:"d/m/Y" }}</td>

                    <td class="text-end">
                      <a class="btn btn-outline-primary btn-sm"
                         href="{% url 'detalle_historico' historico_id=h.id %}">Ver</a>

                      <a class="btn btn-outline-secondary btn-sm"
                         href="{% url 'editar_historico' historico_id=h.id %}">Editar</a>

                      <a class="btn btn-outline-danger btn-sm"
                         href="{% url 'borrar_historico' historico_id=h.id %}">Borrar</a>

                      <a class="btn btn-outline-dark btn-sm"
                         href="{% url 'detalle_objeto_lugar' h.objeto_del_lugar.id %}">
                        Ir al objeto
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="p-4">
              <div class="alert alert-secondary mb-0 rounded-4">
                No hay históricos
                {% if lugar_actual or objeto_actual or tipo_actual or estado_actual %}
                  para el filtro seleccionado
                {% endif %}.
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}