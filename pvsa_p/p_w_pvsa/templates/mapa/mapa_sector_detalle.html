{# templates/mapa/mapa_sector_detalle.html #}
{% extends "base.html" %}
{% load static %}

{% block extra_link %}
<link href="https://unpkg.com/maplibre-gl@^5.15.0/dist/maplibre-gl.css" rel="stylesheet" />
<style>
  .maplibregl-popup-content{
    border-radius: 14px !important;
    padding: 12px 12px 10px !important;
    box-shadow: 0 10px 30px rgba(0,0,0,.20) !important;
    border: 1px solid rgba(15,23,42,.10);
    max-width: 320px;
  }
  .maplibregl-popup-content .btn{ width:100%; }
</style>
{% endblock %}

{% block content %}
<div id="sector-meta" data-sector-id="{{ sector.id }}"></div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-0">Detalle mapa · Sector</h3>
    <div class="text-muted small">{{ sector.sector }}</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'mapa_admin' %}">Volver</a>
    <a class="btn btn-primary" href="{% url 'mapa_sector_editar_geom' sector.id %}">Editar polígono</a>
    <form method="post" action="{% url 'mapa_sector_quitar_geom' sector.id %}">
      {% csrf_token %}
      <button class="btn btn-outline-danger" type="submit">Quitar del mapa</button>
    </form>
  </div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white border-0">
        <strong>Elementos dentro del sector</strong>
        <div class="small text-muted">Click para enfocar</div>
      </div>
      <div class="card-body">
        <div class="list-group" id="listaItems" style="max-height: 65vh; overflow:auto;"></div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-8">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
        <strong>Mapa (SATELITAL)</strong>
        <span class="badge bg-light text-muted fw-normal">Click en un polígono para acciones</span>
      </div>
      <div class="card-body">
        <div id="mapDetalle" style="height:70vh;"></div>
      </div>
    </div>
  </div>
</div>

{% if geom %}{{ geom|json_script:"geom-sector" }}{% endif %}
{% if ubic_fc %}{{ ubic_fc|json_script:"ubic-fc" }}{% endif %}
{% if mapa_geojson %}{{ mapa_geojson|json_script:"mapa-data" }}{% endif %}
{% endblock %}

{% block extra_script %}
<script src="https://unpkg.com/maplibre-gl@^5.15.0/dist/maplibre-gl.js"></script>
<script>
(() => {
  const MAX_ZOOM = 19;

  const STYLE = {
    version: 8,
    sources: {
      sat: {
        type: "raster",
        tiles: ["https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"],
        tileSize: 256,
        maxzoom: MAX_ZOOM,
        attribution: "Esri"
      }
    },
    layers: [{ id: "sat", type: "raster", source: "sat" }]
  };

  const map = new maplibregl.Map({
    container: "mapDetalle",
    style: STYLE,
    center: [-71.484847, -32.752389],
    zoom: 17,
    maxZoom: MAX_ZOOM
  });
  map.addControl(new maplibregl.NavigationControl(), "top-right");

  const sectorId = String(document.getElementById("sector-meta")?.dataset.sectorId || "");

  function asNumOrNull(x){
    const n = Number(x);
    return isFinite(n) ? n : null;
  }
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function hexToRgb(h){
    const x=(h||"").replace("#","").trim();
    const v=x.length===3?x.split("").map(c=>c+c).join(""):x;
    return {r:parseInt(v.slice(0,2),16), g:parseInt(v.slice(2,4),16), b:parseInt(v.slice(4,6),16)};
  }
  function rgbToHex(r,g,b){ const f=n=>n.toString(16).padStart(2,"0"); return `#${f(r)}${f(g)}${f(b)}`; }
  function mixHex(a,b,t){
    const pa=hexToRgb(a), pb=hexToRgb(b);
    return rgbToHex(
      Math.round(pa.r+(pb.r-pa.r)*t),
      Math.round(pa.g+(pb.g-pa.g)*t),
      Math.round(pa.b+(pb.b-pa.b)*t)
    );
  }
  function colorForPct(pct){
    pct = Number(pct);
    if (!isFinite(pct)) return "#64748b";
    if (pct >= 65) return mixHex("#86efac","#16a34a",(clamp(pct,65,100)-65)/35);
    if (pct >= 50) return "#facc15";
    return mixHex("#7f1d1d","#f87171", clamp(pct,0,49)/49);
  }
  function badgeForPct(pct){
    if (pct === null || pct === undefined) return {label:"Sin datos", color:"#64748b"};
    return {label:`${pct}% Bueno`, color: colorForPct(pct)};
  }

  function coordsFromGeom(geom){
    if (!geom) return [];
    if (geom.type === "Polygon") {
      const out=[]; (geom.coordinates||[]).forEach(r => (r||[]).forEach(c => out.push(c)));
      return out;
    }
    if (geom.type === "MultiPolygon") {
      const out=[]; (geom.coordinates||[]).forEach(poly => (poly||[]).forEach(r => (r||[]).forEach(c => out.push(c))));
      return out;
    }
    return [];
  }
  function bboxFromGeom(geom){
    const coords = coordsFromGeom(geom);
    let minX=999,minY=999,maxX=-999,maxY=-999;
    coords.forEach(([x,y])=>{ minX=Math.min(minX,x); minY=Math.min(minY,y); maxX=Math.max(maxX,x); maxY=Math.max(maxY,y); });
    return (minX===999)?null:[[minX,minY],[maxX,maxY]];
  }
  function bboxFromFC(fc){
    let minX=999,minY=999,maxX=-999,maxY=-999;
    (fc.features||[]).forEach(f=>{
      const bb=bboxFromGeom(f.geometry); if(!bb) return;
      minX=Math.min(minX,bb[0][0]); minY=Math.min(minY,bb[0][1]);
      maxX=Math.max(maxX,bb[1][0]); maxY=Math.max(maxY,bb[1][1]);
    });
    return (minX===999)?null:[[minX,minY],[maxX,maxY]];
  }
  function centroidFromGeom(geom){
    const coords = coordsFromGeom(geom);
    if (!coords.length) return null;
    let sx=0, sy=0;
    coords.forEach(([x,y])=>{ sx+=x; sy+=y; });
    return [sx/coords.length, sy/coords.length];
  }

  const sectorEl = document.getElementById("geom-sector");
  const sectorGeom = sectorEl ? (JSON.parse(sectorEl.textContent).geometry || JSON.parse(sectorEl.textContent)) : null;

  const allEl = document.getElementById("mapa-data");
  const allFC = allEl ? JSON.parse(allEl.textContent) : null;

  const ubicEl = document.getElementById("ubic-fc");
  const ubicFCraw = ubicEl ? JSON.parse(ubicEl.textContent) : { type:"FeatureCollection", features:[] };

  function normalizeItemsFC(){
    let fc = { type:"FeatureCollection", features: [] };

    if (allFC && allFC.type === "FeatureCollection") {
      fc.features = (allFC.features || []).filter(f => {
        const p = f.properties || {};
        if (!f.geometry) return false;
        if (String(p.sector_id) !== sectorId) return false;

        if (p.kind === "ubicacion") return true;
        if (p.kind === "lugar" && (p.is_movil === true || p.is_movil === "true")) return true;

        return false;
      });
    } else if (ubicFCraw && ubicFCraw.type === "FeatureCollection") {
      fc = ubicFCraw;
    }

    fc.features = (fc.features || []).map(f => {
      const p = f.properties || {};
      const pct = asNumOrNull(p.pct ?? p.pct_buenas ?? null);
      const hasPct = (pct !== null);
      return {
        ...f,
        properties: {
          ...p,
          pct: hasPct ? pct : null,
          hasPct: hasPct
        }
      };
    });

    return fc;
  }

  const itemsFC = normalizeItemsFC();

  const lista = document.getElementById("listaItems");
  let popup = null;

  function popupForFeature(f, lngLat){
    const p = f.properties || {};
    const isMovil = (p.kind === "lugar" && (p.is_movil === true || p.is_movil === "true"));
    const pct = asNumOrNull(p.pct);
    const badge = badgeForPct(pct);

    const kindLabel = (p.kind === "ubicacion") ? "UBICACIÓN" : (isMovil ? "CONTENEDOR / MÓVIL" : "LUGAR");
    const sub = (p.kind === "ubicacion") ? (p.sector_name || "") : (p.sector_name || "");

    const html = `
      <div style="min-width:240px">
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div>
            <div class="fw-semibold mb-1">${p.name || "-"}</div>
            <div class="small text-muted">${kindLabel}${sub ? " · " + sub : ""}</div>
          </div>
          <span style="font-size:12px;color:white;background:${badge.color};padding:4px 8px;border-radius:999px;white-space:nowrap;">
            ${badge.label}
          </span>
        </div>

        ${
          pct === null
            ? `<div class="small text-muted mt-2">Sin datos para calcular % Bueno</div>`
            : `
              <div class="mt-2">
                <div class="d-flex justify-content-between small">
                  <span class="text-muted">Calidad</span>
                  <span class="fw-semibold">${pct}% Bueno</span>
                </div>
                <div style="height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden;">
                  <div style="width:${Math.max(0, Math.min(100, pct))}%;height:10px;background:${badge.color};"></div>
                </div>
              </div>
            `
        }

        <div class="d-grid gap-1 mt-3">
          ${p.detail_url ? `<a class="btn btn-sm btn-outline-primary" href="${p.detail_url}">Detalles</a>` : ``}
          ${p.edit_geom_url ? `<a class="btn btn-sm btn-primary" href="${p.edit_geom_url}">Editar polígono</a>` : ``}
        </div>
      </div>
    `;

    if (popup) popup.remove();
    popup = new maplibregl.Popup({ closeOnClick:true, maxWidth:"320px" })
      .setLngLat(lngLat || map.getCenter())
      .setHTML(html)
      .addTo(map);
  }

  function renderList(){
    if (!lista) return;
    lista.innerHTML = "";

    const feats = itemsFC.features || [];
    if (!feats.length){
      lista.innerHTML = `<div class="text-muted small">No hay polígonos dentro del sector.</div>`;
      return;
    }

    feats.forEach(f => {
      const p = f.properties || {};
      const isMovil = (p.kind === "lugar" && (p.is_movil === true || p.is_movil === "true"));
      const kind = (p.kind === "ubicacion") ? "UBICACIÓN" : (isMovil ? "MÓVIL" : "LUGAR");

      const pct = asNumOrNull(p.pct);
      const badge = badgeForPct(pct);

      const item = document.createElement("a");
      item.href = "javascript:void(0)";
      item.className = "list-group-item list-group-item-action";
      item.innerHTML = `
        <div class="d-flex justify-content-between align-items-center gap-2">
          <div>
            <div class="fw-semibold">${p.name || "-"}</div>
            <div class="small text-muted">${kind}</div>
          </div>
          <span style="font-size:12px;color:white;background:${badge.color};padding:4px 8px;border-radius:999px;white-space:nowrap;">
            ${badge.label}
          </span>
        </div>
      `;
      item.addEventListener("click", () => {
        const bb = bboxFromGeom(f.geometry);
        if (bb) map.fitBounds(bb, { padding: 60, maxZoom: MAX_ZOOM });
        const c = centroidFromGeom(f.geometry);
        popupForFeature(f, c ? {lng:c[0], lat:c[1]} : map.getCenter());
      });
      lista.appendChild(item);
    });
  }

  map.on("load", () => {
    if (sectorGeom && (sectorGeom.type === "Polygon" || sectorGeom.type === "MultiPolygon")) {
      map.addSource("sector", { type:"geojson", data:{ type:"Feature", geometry: sectorGeom, properties:{} } });
      map.addLayer({ id:"sector-fill", type:"fill", source:"sector", paint:{ "fill-color":"#06b6b9", "fill-opacity":0.12 } });
      map.addLayer({ id:"sector-line", type:"line", source:"sector", paint:{ "line-color":"#0f172a", "line-width":3 } });
    }

    map.addSource("items", { type:"geojson", data: itemsFC });

    map.addLayer({
      id:"items-fill",
      type:"fill",
      source:"items",
      paint:{
        "fill-color":[
          "case",
          ["==", ["get","hasPct"], true],
          [
            "case",
            [">=", ["get","pct"], 65],
            ["interpolate", ["linear"], ["get","pct"], 65, "#86efac", 100, "#16a34a"],
            [">=", ["get","pct"], 50],
            "#facc15",
            ["interpolate", ["linear"], ["get","pct"], 0, "#7f1d1d", 49, "#f87171"]
          ],
          [
            "case",
            ["==", ["get","kind"], "ubicacion"], "#0d6efd",
            "#a855f7"
          ]
        ],
        "fill-opacity": 0.35
      }
    });

    map.addLayer({
      id:"items-line",
      type:"line",
      source:"items",
      paint:{
        "line-color":[
          "case",
          ["==", ["get","hasPct"], true],
          [
            "case",
            [">=", ["get","pct"], 65], "#15803d",
            [">=", ["get","pct"], 50], "#a16207",
            "#991b1b"
          ],
          [
            "case",
            ["==", ["get","kind"], "ubicacion"], "#0b5ed7",
            "#7c3aed"
          ]
        ],
        "line-width": 3
      }
    });

    map.addLayer({
      id:"items-label",
      type:"symbol",
      source:"items",
      layout:{ "text-field":["get","name"], "text-size":12 }
    });

    map.on("click", "items-fill", (e) => {
      const f = e.features && e.features[0];
      if (!f) return;
      popupForFeature(f, e.lngLat);
    });

    renderList();

    const bbSector = bboxFromGeom(sectorGeom);
    const bbItems = bboxFromFC(itemsFC);
    const bb = bbSector || bbItems;
    if (bb) map.fitBounds(bb, { padding: 50, maxZoom: MAX_ZOOM });
  });
})();
</script>
{% endblock %}
