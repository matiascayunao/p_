{% extends "base.html" %}
{% load static %}

{% block extra_link %}
<link href="https://unpkg.com/maplibre-gl@^5.15.0/dist/maplibre-gl.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-0">Detalle mapa · Sector</h3>
    <div class="text-muted small">{{ sector.sector }}</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'mapa_admin' %}">Volver</a>
    <a class="btn btn-primary" href="{% url 'mapa_sector_editar_geom' sector.id %}">Editar polígono</a>
    <form method="post" action="{% url 'mapa_sector_quitar_geom' sector.id %}">
      {% csrf_token %}
      <button class="btn btn-outline-danger" type="submit">Quitar del mapa</button>
    </form>
  </div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white border-0">
        <strong>Ubicaciones dentro del sector</strong>
        <div class="small text-muted">Click en una ubicación para enfocarla</div>
      </div>
      <div class="card-body">
        <div class="list-group" id="listaUbic" style="max-height: 65vh; overflow:auto;"></div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-8">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
        <strong>Mapa (SATELITAL)</strong>
        <span class="badge bg-light text-muted fw-normal">Click en una ubicación para ver acciones</span>
      </div>
      <div class="card-body">
        <div id="mapDetalle" style="height:70vh;"></div>
      </div>
    </div>
  </div>
</div>

{% if geom %}{{ geom|json_script:"geom-sector" }}{% endif %}
{{ ubic_fc|json_script:"ubic-fc" }}

{% endblock %}

{% block extra_script %}
<script src="https://unpkg.com/maplibre-gl@^5.15.0/dist/maplibre-gl.js"></script>
<script>
  const MAX_ZOOM = 19;

  const STYLE = {
    version: 8,
    sources: {
      sat: {
        type: "raster",
        tiles: ["https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"],
        tileSize: 256,
        maxzoom: MAX_ZOOM,
        attribution: "Esri"
      }
    },
    layers: [{ id: "sat", type: "raster", source: "sat" }]
  };

  const map = new maplibregl.Map({
    container: "mapDetalle",
    style: STYLE,
    center: [-71.484847, -32.752389],
    zoom: 17,
    maxZoom: MAX_ZOOM
  });
  map.addControl(new maplibregl.NavigationControl(), "top-right");

  const sectorEl = document.getElementById("geom-sector");
  const sectorGeom = sectorEl ? JSON.parse(sectorEl.textContent) : null;

  const ubicEl = document.getElementById("ubic-fc");
  const ubicFC = ubicEl ? JSON.parse(ubicEl.textContent) : { type:"FeatureCollection", features: [] };

  const lista = document.getElementById("listaUbic");
  let popup = null;

  function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

  function mixHex(a, b, t) {
    const pa = hexToRgb(a), pb = hexToRgb(b);
    const r = Math.round(pa.r + (pb.r - pa.r) * t);
    const g = Math.round(pa.g + (pb.g - pa.g) * t);
    const bl = Math.round(pa.b + (pb.b - pa.b) * t);
    return rgbToHex(r, g, bl);
  }
  function hexToRgb(h) {
    const x = h.replace("#","").trim();
    const v = x.length === 3 ? x.split("").map(c => c + c).join("") : x;
    return { r: parseInt(v.slice(0,2),16), g: parseInt(v.slice(2,4),16), b: parseInt(v.slice(4,6),16) };
  }
  function rgbToHex(r,g,b){ const f=n=>n.toString(16).padStart(2,"0"); return `#${f(r)}${f(g)}${f(b)}`; }

  function colorForPct(pct) {
    if (pct === null || pct === undefined || pct === "") return "#64748b";
    pct = Number(pct);
    if (!isFinite(pct)) return "#64748b";

    if (pct >= 65) {
      const t = (clamp(pct, 65, 100) - 65) / 35;
      return mixHex("#86efac", "#16a34a", t);
    }
    if (pct >= 50) return "#facc15";

    const t = clamp(pct, 0, 49) / 49;
    return mixHex("#7f1d1d", "#f87171", t);
  }

  function badgeForPct(hasPct, pct) {
    if (!hasPct) return { label: "Sin datos", color: "#64748b" };
    return { label: `${pct}% Bueno`, color: colorForPct(pct) };
  }

  function bboxFromPolygonGeom(geom) {
    const coords = geom?.coordinates?.[0] || [];
    let minX=999, minY=999, maxX=-999, maxY=-999;
    coords.forEach(([x,y]) => { minX=Math.min(minX,x); minY=Math.min(minY,y); maxX=Math.max(maxX,x); maxY=Math.max(maxY,y); });
    if (minX === 999) return null;
    return [[minX,minY],[maxX,maxY]];
  }

  function zoomToFeature(f) {
    const coords = f.geometry?.coordinates?.[0] || [];
    let minX=999, minY=999, maxX=-999, maxY=-999;
    coords.forEach(([x,y]) => { minX=Math.min(minX,x); minY=Math.min(minY,y); maxX=Math.max(maxX,x); maxY=Math.max(maxY,y); });
    if (minX < 999) map.fitBounds([[minX,minY],[maxX,maxY]], { padding: 60, maxZoom: MAX_ZOOM });
  }

  function renderList() {
    lista.innerHTML = "";
    const feats = ubicFC.features || [];
    if (!feats.length) {
      lista.innerHTML = `<div class="text-muted small">No hay ubicaciones con polígono en este sector.</div>`;
      return;
    }

    feats.forEach(f => {
      const p = f.properties || {};
      const badge = badgeForPct(!!p.hasPct, p.pct);

      const item = document.createElement("a");
      item.href = "javascript:void(0)";
      item.className = "list-group-item list-group-item-action";
      item.innerHTML = `
        <div class="d-flex justify-content-between align-items-center gap-2">
          <div>
            <div class="fw-semibold">${p.name || "-"}</div>
            <div class="small text-muted">Ubicación · ${p.sector_name || ""}</div>
          </div>
          <span style="font-size:12px;color:white;background:${badge.color};padding:4px 8px;border-radius:999px;white-space:nowrap;">
            ${badge.label}
          </span>
        </div>
      `;
      item.addEventListener("click", () => {
        zoomToFeature(f);
        popupForFeature(f);
      });
      lista.appendChild(item);
    });
  }

  function popupForFeature(f) {
    const p = f.properties || {};
    const badge = badgeForPct(!!p.hasPct, p.pct);

    const bar = (!p.hasPct)
      ? `<div class="small text-muted">Sin datos para calcular % Bueno</div>`
      : `
        <div class="mt-2">
          <div class="d-flex justify-content-between small">
            <span class="text-muted">Calidad</span>
            <span class="fw-semibold">${p.pct}% Bueno</span>
          </div>
          <div style="height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden;">
            <div style="width:${Math.max(0, Math.min(100, Number(p.pct)))}%;height:10px;background:${badge.color};"></div>
          </div>
          <div class="small text-muted mt-2">
            Total: <b>${p.total||0}</b> · Buenas: <b>${p.buenas||0}</b> · Pend: <b>${p.pendientes||0}</b> · Malas: <b>${p.malas||0}</b>
          </div>
        </div>
      `;

    const html = `
      <div style="min-width:260px">
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div>
            <div class="fw-semibold mb-1">${p.name || "-"}</div>
            <div class="small text-muted">UBICACION · ${p.sector_name || ""}</div>
          </div>
          <span style="font-size:12px;color:white;background:${badge.color};padding:4px 8px;border-radius:999px;white-space:nowrap;">
            ${badge.label}
          </span>
        </div>

        ${bar}

        <div class="d-grid gap-1 mt-3">
          <a class="btn btn-sm btn-outline-primary" href="${p.detail_url}">Detalle ubicación</a>
          <a class="btn btn-sm btn-primary" href="${p.edit_geom_url}">Editar polígono</a>
        </div>
      </div>
    `;

    if (popup) popup.remove();
    popup = new maplibregl.Popup({ closeOnClick: true })
      .setLngLat(map.getCenter())
      .setHTML(html)
      .addTo(map);
  }

  map.on("load", () => {
    // 1) Sector (contorno)
    if (sectorGeom) {
      map.addSource("sector", { type: "geojson", data: { type:"Feature", geometry: sectorGeom, properties:{} } });
      map.addLayer({ id:"sector-fill", type:"fill", source:"sector", paint:{ "fill-color":"#06b6b9", "fill-opacity":0.12 } });
      map.addLayer({ id:"sector-line", type:"line", source:"sector", paint:{ "line-color":"#0f172a", "line-width":3 } });
    }

    // 2) Ubicaciones (coloreadas por % bueno)
    map.addSource("ubics", { type: "geojson", data: ubicFC });

    map.addLayer({
      id: "ubics-fill",
      type: "fill",
      source: "ubics",
      paint: {
        "fill-color": [
          "case",
          ["==", ["get", "hasPct"], true],
          [
            "case",
            [">=", ["get", "pct"], 65],
            ["interpolate", ["linear"], ["get", "pct"], 65, "#86efac", 100, "#16a34a"],
            [">=", ["get", "pct"], 50],
            "#facc15",
            ["interpolate", ["linear"], ["get", "pct"], 0, "#7f1d1d", 49, "#f87171"]
          ],
          "#64748b"
        ],
        "fill-opacity": 0.35
      }
    });

    map.addLayer({
      id: "ubics-line",
      type: "line",
      source: "ubics",
      paint: {
        "line-color": [
          "case",
          ["==", ["get", "hasPct"], true],
          [
            "case",
            [">=", ["get", "pct"], 65], "#15803d",
            [">=", ["get", "pct"], 50], "#a16207",
            "#991b1b"
          ],
          "#334155"
        ],
        "line-width": 3
      }
    });

    map.addLayer({
      id: "ubics-label",
      type: "symbol",
      source: "ubics",
      layout: { "text-field": ["get", "name"], "text-size": 12 }
    });

    map.on("click", "ubics-fill", (e) => {
      const f = e.features && e.features[0];
      if (!f) return;
      popupForFeature(f);
    });

    renderList();

    // fit al sector
    const bb = bboxFromPolygonGeom(sectorGeom);
    if (bb) map.fitBounds(bb, { padding: 50, maxZoom: MAX_ZOOM });
  });
</script>
{% endblock %}